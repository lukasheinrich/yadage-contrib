<!DOCTYPE HTML>
<html>
<head>


    <script type="text/javascript" src="static/components/lodash/dist/lodash.js"></script>
    <script type="text/javascript" src="static/components/vis/dist/vis.js"></script>

    <link href="static/components/vis/dist/vis.css" rel="stylesheet" type="text/css" />

    <script type="text/javascript" src="//code.jquery.com/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        var edges = undefined;
        var nodes = undefined;

        function initialize_graph(){
          // create an array with nodes
          nodes = new vis.DataSet([]);

          // create an array with edges
          edges = new vis.DataSet([]);

          // create a network
          var container = document.getElementById('mynetwork');

          // provide the data in the vis format
          var data = {
              nodes: nodes,
              edges: edges
          };
          var options = {
            edges:{
              arrows: {
                to: {enabled: true, scaleFactor:1, type:'arrow'},
              }
            },
            physics: {
              enabled: true
            },
            layout : {
                randomSeed: 1234,
                hierarchical: {
                    direction: 'UD',
                    sortMethod: 'directed'
                }
            }
          };

          // initialize your network!
          console.log('initialize...')
          var network = new vis.Network(container, data, options);
        }

        function update_graph(node_data, edge_data){
          state_color = {
            SUCCESS: 'green',
            FAILED: 'red',
            DEFINED: 'grey',
            RUNNING: 'yellow'
          }

          // nodes.clear();
          nodes.update(_.map(node_data ,function(x){
            return {id: x.id, label: x.name, color: state_color[x.state]}
          }));

          // edges.clear();
          edges.update(_.map(edge_data ,function(x,index){
            return {id: index, from: x[0], to: x[1]}
          }));
        }

        $(document).ready(function(){
            initialize_graph();

            namespace = '/test';
            var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);

            socket.on('connect', function() {
                socket.emit('frontendmessage', {data: 'I\'m connected!'});
                $('#log').append('<br>Connected!');
            });
            socket.on('disconnect', function() {
                $('#log').append('<br>Disconnected');
            });
            socket.on('servermessage', function(msg) {
                $('#log').append('<br>Received: ' + JSON.stringify(msg.data));
            });

            socket.on('yadage_state', function(msg){
              update_graph(msg.data.dag.nodes, msg.data.dag.edges)
            })

            socket.emit('frontendmessage', {data: 'Echo This!'});
        });
    </script>

    <style type="text/css">
        #mynetwork {
            margin: auto;
            width: 70%;
            height: 100px;
            min-height: 500px;
            /*border: 1px solid black;*/
        }
    </style>
</head>
<body>
  <div id="mynetwork"></div>
</body>
</html>
